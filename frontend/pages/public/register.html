<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link rel="icon" type="image/svg+xml" href="/frontend/assets/icon/tooth.svg">
    <title>DistriCampo - Registro</title>


    <!-- Bootstrap CSS -->
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"   
        rel="stylesheet"
    />
    
    <!-- Bootstrap Icons -->
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
        rel="stylesheet" 
    />
  

    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">


    <!-- Google Fonts: Material Symbols and Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>


    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
     

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/frontend/assets/css/register.css" />
</head>
<body>

    <!-- HERO-->
    <div class="background-container">
        <img alt="Fondo de DistriCampo" class="background-image" src="/frontend/assets/img/background-login.png"/>
        <div class="overlay"></div>
    </div>

    <!-- FORMULARIO -->
    <div class="main-content">
        <div class="card">
            <div class="header">
                <div class="flex items-center justify-center space-x-2 mb-3"> 
                    <img src="/frontend/assets/icon/footer.svg" alt="">
                </div>
                <h2 class="title">Regístrate</h2>
                <p class="subtitle">Crea tu cuenta para acceder a nuestros productos y servicios</p>
            </div>

            <div id="successMessage" class="message success hidden">
                <div class="flex items-center">
                    <span class="material-symbols-outlined mr-2">check_circle</span>
                    <span id="successText">Registro exitoso</span>
                </div>
            </div>
            <div id="errorMessage" class="message error hidden">
                <div class="flex items-center">
                    <span class="material-symbols-outlined mr-2">error</span>
                    <span id="errorText">Error al registrar</span>
                </div>
            </div>
            <div id="loadingMessage" class="message loading hidden">
                <div class="flex items-center">
                    <span class="loading material-symbols-outlined mr-2">refresh</span>
                    <span>Registrando usuario...</span>
                </div>
            </div>

            <form id="registerForm">  
                <div class="form-row">
                    <div>
                        <label for="nombre" class="label">Nombre*</label>
                        <div class="input-group"> 
                            <input type="text" id="nombre" name="nombre" required class="input-field" placeholder="Ingresa tus nombres">
                        </div>
                    </div>
                    <div>
                        <label for="apellido" class="label">Apellido*</label>
                        <div class="input-group"> 
                            <input type="text" id="apellido" name="apellido" required class="input-field" placeholder="Ingresa tus apellidos">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="dni" class="label">DNI*</label>
                    <div class="input-group">
                        <span class="material-symbols-outlined input-icon">id_card</span> 
                        <input type="text" id="dni" name="dni" required class="input-field" placeholder="72072072">
                    </div>
                </div>

                <div class="form-group">
                    <label for="correoElectronico" class="label">Correo Electrónico*</label>
                    <div class="input-group">
                        <span class="material-symbols-outlined input-icon">mail</span>
                        <input type="email" id="correoElectronico" name="correoElectronico" required class="input-field" placeholder="tu@email.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="telefono" class="label">Teléfono*</label>
                    <div class="input-group">
                        <span class="material-symbols-outlined input-icon">phone</span>
                        <input type="tel" id="telefono" name="telefono" required class="input-field" placeholder="+51 999 999 999">
                    </div>
                </div>

                <div class="form-group">
                    <label for="contrasena" class="label">Contraseña*</label>
                    <div class="input-group">
                        <span class="material-symbols-outlined input-icon">lock</span>
                        <input type="password" id="contrasena" name="contrasena" required class="input-field" placeholder="Mínimo 6 caracteres">
                    </div>
                    <div id="passwordValidation" class="password-info">
                        <div class="progress-bar-container">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                        
                        <div class="validation-row">
                            <p id="lengthReq" class="validation-item invalid flex items-center">
                                <span class="material-symbols-outlined mr-1" style="font-size: 1rem;">check</span>Mínimo 6 caracteres
                            </p>
                            <p id="matchReq" class="validation-item invalid flex items-center">
                                <span class="material-symbols-outlined mr-1" style="font-size: 1rem;">check</span>Contraseñas coinciden
                            </p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmarContrasena" class="label">Confirmar Contraseña*</label>
                    <div class="input-group">
                        <span class="material-symbols-outlined input-icon">lock</span>
                        <input type="password" id="confirmarContrasena" name="confirmarContrasena" required class="input-field" placeholder="Repite tu contraseña">
                    </div>
                </div>
                
                <div class="terms-group">
                    <label class="terms-text flex items-center">
                        <input type="checkbox" id="termsAndConditions" name="termsAndConditions" required class="custom-checkbox">
                        <span class="checkmark"></span>
                        Acepto los <a href="/terms" class="terms-link ml-1">Términos y Condiciones</a>
                    </label>
                </div>

                <br>

                <button type="submit" id="submitBtn" class="submit-btn">
                    <span id="submitText">Crear Cuenta</span>
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-white">
                    ¿Ya tienes una cuenta? 
                    <a href="login.html" class="link">Inicia Sesión aquí</a>
                </p>
            </div>

            <div class="text-center mt-6">
                <a href="index.html" class="link text-white">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Volver al inicio
                </a>
            </div>
        </div>
    </div>

    <!-- Bootstrap & JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


    <script>
         document.addEventListener('DOMContentLoaded', () => {
            const contrasena = document.getElementById('contrasena');
            const confirmarContrasena = document.getElementById('confirmarContrasena');
            const registerForm = document.getElementById('registerForm');
            const submitBtn = document.getElementById('submitBtn');

            const progressBar = document.getElementById('progressBar');
            const lengthReq = document.getElementById('lengthReq');
            const matchReq = document.getElementById('matchReq');

            // ------------------------------------
            // 1. Lógica de la Barra de Progreso y Requisitos
            // ------------------------------------

            function updatePasswordValidation() {
                const pass1 = contrasena.value;
                const pass2 = confirmarContrasena.value;
                let progress = 0;
                let isValidLength = false;
                let isMatch = false;

                // Validación 1: Mínimo 6 caracteres
                if (pass1.length >= 6) {
                    isValidLength = true;
                    progress += 50; // 50% por cumplir el primer requisito
                    lengthReq.classList.remove('invalid');
                    lengthReq.classList.add('valid');
                } else {
                    lengthReq.classList.remove('valid');
                    lengthReq.classList.add('invalid');
                }

                // Validación 2: Coincidencia de contraseñas
                if (pass2.length > 0 && pass1 === pass2 && isValidLength) {
                    isMatch = true;
                    progress = 100; // 100% si coinciden y cumplen longitud
                    matchReq.classList.remove('invalid');
                    matchReq.classList.add('valid');
                    progressBar.classList.add('complete');
                } else if (pass2.length > 0 && pass1 !== pass2) {
                    isMatch = false;
                    matchReq.classList.remove('valid');
                    matchReq.classList.add('invalid');
                    progressBar.classList.remove('complete');
                    if (isValidLength) progress = 50; // Vuelve a 50% si no coinciden
                } else {
                    isMatch = false;
                    matchReq.classList.remove('valid');
                    matchReq.classList.add('invalid');
                    progressBar.classList.remove('complete');
                }

                // Actualizar la barra de progreso
                progressBar.style.width = progress + '%';
                
                // Habilitar/Deshabilitar el botón de envío
                submitBtn.disabled = !(isValidLength && isMatch);
                
                // Asegurar que el requisito de match se muestre como inválido si está vacío
                 if (pass2.length === 0) {
                    matchReq.classList.remove('valid');
                    matchReq.classList.add('invalid');
                 }
            }

            // Escuchar los eventos de escritura
            contrasena.addEventListener('input', updatePasswordValidation);
            confirmarContrasena.addEventListener('input', updatePasswordValidation);

            // ------------------------------------
            // 2. Lógica de Envío de Formulario (Simulada)
            // ------------------------------------

            registerForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                hideMessages();

                // Validación final
                const pass1 = contrasena.value;
                const pass2 = confirmarContrasena.value;

                if (!pass1 || pass1.length < 6 || pass1 !== pass2) {
                    showError('Verifica que las contraseñas tengan mínimo 6 caracteres y coincidan.');
                    return;
                }
                
                const nombre = document.getElementById('nombre').value;
                const apellido = document.getElementById('apellido').value;
                const dni = document.getElementById('dni').value;
                const correoElectronico = document.getElementById('correoElectronico').value;
                const telefono = document.getElementById('telefono').value;

                if (!nombre || !apellido || !dni || !correoElectronico || !telefono) {
                    showError('Por favor completa todos los campos requeridos.');
                    return;
                }

                setSubmitLoading(true, 'Creando cuenta...');

                try {
                    const res = await fetch("http://localhost:4000/api/auth/register", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            nombre: nombre,
                            apellido: apellido,
                            dni: document.getElementById('dni')?.value || '',
                            telefono: telefono, 
                            correo: correoElectronico,
                            contrasena: pass1,
                            rol: "paciente" // Por defecto
                        }),
                    });



                    const data = await res.json();

                    if (!res.ok) {
                        showError(data.message || "Error al registrar usuario");
                        setSubmitLoading(false);
                        return;
                    }

                    showSuccess("¡Cuenta creada con éxito!");
                    setSubmitLoading(false);

                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 1500);
                } catch (error) {
                    console.error(error);
                    showError("Error del servidor. Intenta más tarde.");
                    setSubmitLoading(false);
                }

                
                setTimeout(() => {
                    // window.location.href = '/login'; // Redireccionar después de registro
                }, 2000);
            });

            // ------------------------------------
            // 3. Funciones de Utilidad (Adaptadas a CSS puro)
            // ------------------------------------
            function setSubmitLoading(loading, text = 'Crear Cuenta') {
                const submitText = document.getElementById('submitText');
                
                if (loading) {
                    submitBtn.disabled = true;
                    submitText.innerHTML = `<span class="loading material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">refresh</span>${text}`;
                } else {
                    submitBtn.disabled = false;
                    submitText.textContent = 'Crear Cuenta';
                }
            }

            function showSuccess(message) {
                document.getElementById('successText').textContent = message;
                document.getElementById('successMessage').style.display = 'flex';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('loadingMessage').style.display = 'none';
            }

            function showError(message) {
                document.getElementById('errorText').textContent = message;
                document.getElementById('errorMessage').style.display = 'flex';
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('loadingMessage').style.display = 'none';
            }

            function hideMessages() {
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('loadingMessage').style.display = 'none';
            }
            
            // Inicializar la validación al cargar
            updatePasswordValidation();
        });
 
    </script>
</body>
</html>